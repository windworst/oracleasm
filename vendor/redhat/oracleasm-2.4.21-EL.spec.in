#
# Spec file for oracleasm
#

# Macros
# This one is hardcoded because, well, it belongs there
%define _prefix /usr
# Because RPM is dumb
%define _unpackaged_files_terminate_build 0

# Turn on's and off's (summit and debug not used but added
# for future proofing)
%define buildup		1
%define buildsmp	1
%define buildhugemem	1
%define builddebug	0

# From the EL3 kernel specfile
%ifnarch i686
%define buildhugemem 0
%endif

%ifarch s390 s390x
%define buildsmp 0
%endif
%ifarch ppc64pseries ppc64iseries
%define buildsmp 0
%endif
%ifarch ia64
%define buildsmp	0
%endif


# This must be changed to the minimum ABI compat kernel version expected
%define base 2.4.21
%define abi 2.4.21-EL
%define kver %{base}-4.EL

# The minimum -support package required for the kernel bits.
%define support_ver     1.0.0

Summary: The Oracle Automatic Storage Management library driver.
Name: oracleasm-%{abi}
Version: @DIST_VERSION@
Release: @RPM_VERSION@
Copyright: GPL
Group: System Environment/Kernel
Source: oracleasm-@DIST_VERSION@.tar.gz
URL: http://oss.oracle.com/
Distribution: Oracle
Vendor: Oracle Corporation
Packager: Joel Becker <joel.becker@oracle.com>
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: kernel >= %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source >= %{kver}


BuildRoot: %{_tmppath}/oracleasm-%{PACKAGE_VERSION}-%{PACKAGE_RELEASE}-root


%description
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for uniprocessor kernels.

%if %{buildsmp}
%package smp
Summary: The Oracle Automatic Storage Management library driver for SMP systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
Requires: kernel-smp >= %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source >= %{kver}
AutoReqProv: no


%description smp
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for symmetric multiprocessor kernels.
%endif


%if %{buildhugemem}
%package hugemem
Summary: The Oracle Automatic Storage Management library driver for hugemem systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
Requires: kernel-hugemem >= %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source >= %{kver}
AutoReqProv: no


%description hugemem
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for symmetric multiprocessor kernels on
machines with more than 16GB of RAM.
%endif


%if %{builddebug}
%package debug
Summary: The Oracle Automatic Storage Management library driver for debugging systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
Requires: kernel-debug >= %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source >= %{kver}
AutoReqProv: no


%description debug
Kenrel driver for the Oracle Automatic Storage Management library.
This package is compiled for debugging kernels.
%endif




%prep
%setup -n oracleasm-%{version}


%build
# Hack to find a good source tree
KVER=""
if test -d "/usr/src/linux-%{kver}"; then
    KVER="%{kver}"
else
    CURKVER="`uname -r | awk '{sub(/smp$|hugemem$|debug$/,"");print}'`"
    case "$CURKVER" in
    %{base}*)
        if test -d "/usr/src/linux-${CURKVER}"; then
            KVER="${CURKVER}"
        fi
        ;;
    *)
        ;;
    esac
fi

if test -z "$KVER" ; then
    if test -d "/usr/src/linux-2.4" ; then
        KPATH="/usr/src/linux-2.4"
    elif test -d "/usr/src/linux" ; then
        KPATH="/usr/src/linux"
    else
        echo "No kernel tree to build from!" >&2
        exit 1
    fi
else
    KPATH="/usr/src/linux-${KVER}"
fi
    
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel

%if %{buildup}
make KVER=up
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{abi}-ABI/oracleasm" install 
%endif

%if %{buildsmp}
make clean
make KVER=smp
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{abi}-smp-ABI/oracleasm" install 
%endif

%if %{buildhugemem}
make clean
make KVER=hugemem
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{abi}-hugemem-ABI/oracleasm" install 
%endif

%if %{builddebug}
make clean
make KVER=debug
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{abi}-debug-ABI/oracleasm" install 
%endif



%install



%clean
rm -rf "$RPM_BUILD_ROOT"



%if %{buildup}
%post
/etc/init.d/oracleasm link

%files
%defattr(-,root,root)
/lib/modules/%{abi}-ABI/oracleasm
%endif

%if %{buildsmp}
%post smp
/etc/init.d/oracleasm link

%files smp
%defattr(-,root,root)
/lib/modules/%{abi}-smp-ABI/oracleasm
%endif

%if %{buildhugemem}
%post hugemem
/etc/init.d/oracleasm link

%files hugemem
%defattr(-,root,root)
/lib/modules/%{abi}-hugemem-ABI/oracleasm
%endif

%if %{builddebug}
%post debug
/etc/init.d/oracleasm link

%files debug
%defattr(-,root,root)
/lib/modules/%{abi}-debug-ABI/oracleasm
%endif



%changelog
* Tue Jan 13 2004 Joel Becker <joel.becker@oracle.com>
- Kernel-only EL3 specfile.

* Wed Nov 12 2003 Joel Becker <joel.becker@oracle.com>
- Start the ASM rename.

* Thu Oct 30 2003 Joel Becker <joel.becker@oracle.com>
- Created EL3 version

* Mon Jun 23 2003 Joel Becker <joel.becker@oracle.com>
- Added osm-lib bits

* Fri Jun 20 2003 Joel Becker <joel.becker@oracle.com>
- Initial RPM

