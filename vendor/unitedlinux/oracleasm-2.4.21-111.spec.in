#
# Spec file for oracleasm
#

# Macros
# This one is hardcoded because, well, it belongs there
%define _prefix /usr
# Because RPM is dumb
%define _unpackaged_files_terminate_build 0

# Turn on's and off's (summit and debug not used but added
# for future proofing)
%define builddeflt		1
%define buildsmp		1
%define buildpsmp		1
%define buildnuma		0
%define builditanium2		0
%define builditanium2smp	0

%ifarch ia64
%define builddeflt		0
%define buildsmp		0
%define buildpsmp		0
%define builditanium2		1
%define builditanium2smp	1
%endif

%ifarch x86_64
%define buildpsmp		0
%define buildnuma		1
%endif



# This must be changed to the minimum ABI compat kernel version expected
%define base		2.4.21
%define sver		111
%define kver		%{base}-%{sver}

# The minimum -support package required for the kernel bits.
%define support_ver	1.0.0

Summary: The Oracle Automatic Storage Management library driver.
Name: oracleasm-%{kver}
Version: @DIST_VERSION@
Release: @RPM_VERSION@
Copyright: GPL
Group: System Environment/Kernel
Source: oracleasm-@DIST_VERSION@.tar.gz
URL: http://oss.oracle.com/
Distribution: Oracle
Vendor: Oracle Corporation
Packager: Joel Becker <joel.becker@oracle.com>
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: k_deflt = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}


BuildRoot: %{_tmppath}/asmlib-%{PACKAGE_VERSION}-%{PACKAGE_RELEASE}-root


%description
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for the default kernel.

%if %{builddeflt}
%package deflt
Summary: The Oracle Automatic Storage Management library driver for SMP systems.
Group: System Environment/Kernel
AutoReqProv: no
Provides: oracleasm = %{version}
Requires: k_deflt = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description deflt
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for the default kernel.
%endif


%if %{buildsmp}
%package smp
Summary: The Oracle Automatic Storage Management library driver for SMP systems.
Group: System Environment/Kernel
AutoReqProv: no
Provides: oracleasm = %{version}
Requires: k_smp = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description smp
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for symmetric multiprocessor kernels.
%endif


%if %{buildpsmp}
%package psmp
Summary: The Oracle Automatic Storage Management library driver for NUMA systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: k_psmp = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description psmp
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for Pentium SMP kernels.
%endif


%if %{buildnuma}
%package numa
Summary: The Oracle Automatic Storage Management library driver for NUMA systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: k_numa = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description numa
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for NUMA kernels.
%endif


%if %{builditanium2}
%package itanium2
Summary: The Oracle Automatic Storage Management library driver for UP Itanium2 systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: k_itanium2 = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description itanium2
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for UP Itanium2 kernels.
%endif


%if %{builditanium2smp}
%package itanium2-smp
Summary: The Oracle Automatic Storage Management library driver for SMP Itanium2 systems.
Group: System Environment/Kernel
Provides: oracleasm = %{version}
AutoReqProv: no
Requires: k_itanium2-smp = %{kver}
Requires: oracleasm-support >= %{support_ver}
BuildRequires: kernel-source = %{kver}

%description itanium2-smp
Kernel driver for the Oracle Automatic Storage Management library.
This package is compiled for Itanium2 SMP kernels.
%endif



%prep
%setup -n oracleasm-%{version}


%build

%if %{builddeflt}
KPATH="/usr/src/linux-%{kver}-include/default"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-default/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif

%if %{buildsmp}
KPATH="/usr/src/linux-%{kver}-include/smp"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-smp/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif

%if %{buildpsmp}
KPATH="/usr/src/linux-%{kver}-include/psmp"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-psmp/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif

%if %{buildnuma}
KPATH="/usr/src/linux-%{kver}-include/numa"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-numa/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif

%if %{builditanium2}
KPATH="/usr/src/linux-%{kver}-include/itanium2"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-itanium2/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif

%if %{builditanium2smp}
KPATH="/usr/src/linux-%{kver}-include/itanium2-smp"
%configure --sbindir=/usr/sbin --with-kernel="${KPATH}"
cd kernel
make
make DESTDIR="$RPM_BUILD_ROOT" MODULEDIR="/lib/modules/%{kver}-itanium2-smp/kernel/drivers/addon/oracleasm" install 
make clean
cd ..
%endif




%install



%clean
rm -rf "$RPM_BUILD_ROOT"



%if %{builddeflt}
%post deflt
depmod -a

%files deflt
%defattr(-,root,root)
/lib/modules/%{kver}-default/kernel/drivers/addon/oracleasm
%endif


%if %{buildsmp}
%post smp
depmod -a

%files smp
%defattr(-,root,root)
/lib/modules/%{kver}-smp/kernel/drivers/addon/oracleasm
%endif


%if %{buildpsmp}
%post psmp
depmod -a

%files psmp
%defattr(-,root,root)
/lib/modules/%{kver}-psmp/kernel/drivers/addon/oracleasm
%endif


%if %{buildnuma}
%post numa
depmod -a

%files numa
%defattr(-,root,root)
/lib/modules/%{kver}-numa/kernel/drivers/addon/oracleasm
%endif


%if %{builditanium2}
%post itanium2
depmod -a

%files itanium2
%defattr(-,root,root)
/lib/modules/%{kver}-itanium2/kernel/drivers/addon/oracleasm
%endif


%if %{builditanium2smp}
%post itanium2-smp
depmod -a

%files itanium2-smp
%defattr(-,root,root)
/lib/modules/%{kver}-itanium2-smp/kernel/drivers/addon/oracleasm
%endif




%changelog
* Tue Jan 13 2004 Joel Becker <joel.becker@oracle.com>
- Make kernel-only.

* Thu Nov 20 2003 Joel Becker <joel.becker@oracle.com>
- Add x86 and ia64 targets.

* Wed Nov 19 2003 Joel Becker <joel.becker@oracle.com>
- Make the UL SP3 changes.

* Wed Nov 12 2003 Joel Becker <joel.becker@oracle.com>
- Start the ASM rename.

* Thu Oct 30 2003 Joel Becker <joel.becker@oracle.com>
- Created EL3 version

* Mon Jun 23 2003 Joel Becker <joel.becker@oracle.com>
- Added osm-lib bits

* Fri Jun 20 2003 Joel Becker <joel.becker@oracle.com>
- Initial RPM

