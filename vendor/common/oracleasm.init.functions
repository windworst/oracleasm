# -*-Shell-script-*-
# init functions for oracleasm
#
# Parent caller must have sourced init.d functions
# . /etc/init.d/functions on Red Hat
# . /etc/rc.status on UnitedLinux
#

# Force LC_ALL=C
export LC_ALL=C


#
# dev_create()
#
# Create $1
# Returns 0 on success, 1 on error, 2 if it already exists.
#
dev_create()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "dev_create(): Requires an argument" >&2
        return 1
    fi
    DEV="$1"
    if [ -e "$DEV" ]
    then
        if [ -d "$DEV" ]
        then
            return 2
        fi
        echo "dev_create(): File $DEV is not a directory" >&2
        return 1
    fi

    echo -n "Creating $DEV mount point "
    mkdir "$DEV" 2>/dev/null
    if [ $? != 0 ]
    then
        echo "Unable to create mount point $DEV" >&2
        return 1
    fi
    return 0
}


#
# module_link()
#
# Link $1 from path $2 to $3
# Returns 0 on success, 1 on error, 2 if it already exists.
#
module_link()
{
    if [ "$#" -lt 3 -o -z "$1" -o -z "$2" -o -z "$3" ]
    then
        echo -n "module_link(): Requires 3 arguments" >&2
        return 1
    fi
    MODULENAME="$1"
    SRCPATH="$2"
    TARGETPATH="$3"

    # Assume any symlink is OK - caveat emptor for non-RPM users
    test -L "${TARGETPATH}/${MODULENAME}" && return 2
    # If the source module isn't there, this is a first install
    test -f "${SRCPATH}/${MODULENAME}" || return 2

    echo -n "Linking module ${MODULENAME} into the module path "

    # Same deal for modules that are physically there
    if test -f "${TARGETPATH}/${MODULENAME}" ; then
        EXISTVER="`modinfo "${TARGETPATH}/${MODULENAME}" | awk '/description.*version/{sub(/^.*\(version /, ""); sub(/\)"$/, ""); print;}'`"
        if test -n "${EXISTVER}" ; then
            ABIVER="`modinfo "${SRCPATH}/${MODULENAME}" | awk '/description.*version/{sub(/^.*\(version /, ""); sub(/\)"$/, ""); print;}'`"

            echo
            echo "Leaving existing module in place (ABI module version $ABIVER, existing module version $EXISTVER)"
            return 2
        else
            # The existing module is too old - pre-ABI packaging
            echo
            echo "Warning: Moving ancient ${MODULENAME} out of the way"
            mv -f "${TARGETPATH}/${MODULENAME}" "${TARGETPATH}/${MODULENAME}.preABI" >/dev/null 2>&1
            if test "$?" != 0 ; then
                echo "Unable to move ancient module out of the way" >&2
                return 1
            fi
        fi
    fi

    if test ! -d "$TARGETPATH" ; then
        if test -e "${TARGETPATH}"; then
            echo "Path \"${TARGETPATH}\" already exists, but is not a directory" >&2
            return 1
        else
            mkdir -p "$TARGETPATH" >/dev/null 2>&1
            if test $? != 0; then
                echo "Unable to create directory \"${TARGETPATH}\"" >&2
                return 1
            fi
        fi
    fi

    ln -s "${SRCPATH}/${MODULENAME}" "${TARGETPATH}/${MODULENAME}" >/dev/null 2>&1
    if test $? != 0; then
        echo "Unable to create symbolic link \"${TARGETPATH}/${MODULENAME}\"" >&2
        return 1
    fi
    depmod -a

    return 0
}


#
# load_module()
# Load a module
#
# 0 is success, 1 is error, 2 is already loaded
# 
load_module()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "load_module(): Requires an argument" >&2
        return 1
    fi
    MODNAME="$1"

    MODOUT="`awk '$1 ~ /^'$MODNAME'$/{print $1;exit}' < /proc/modules 2>/dev/null`"
    if [ -n "$MODOUT" ]
    then
        return 2
    fi

    echo -n "Loading module \"$MODNAME\" "
    modprobe -s "$MODNAME"
    if [ "$?" != 0 ]
    then
        echo "Unable to load module \"$MODNAME\"" >&2
        return 1
    fi

    return 0
}

#
# unload_module()
# Unload a module
#
# 0 is success, 1 is error, 2 is not loaded
# 
unload_module()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "unload_module(): Requires an argument" >&2
        return 1
    fi
    MODNAME="$1"

    MODOUT="`awk '$1 ~ /^'$MODNAME'$/{print $1,$3;exit}' < /proc/modules 2>/dev/null`"
    if [ -z "$MODOUT" ]
    then
        return 2
    fi
    case "$MODOUT" in
    $MODNAME\ 0)
        ;;
    $MODNAME\ *)
        return 2
        ;;
    *)
        echo -n "Invalid module parsing! "
        return 1
        ;;
    esac

    echo -n "Unloading module \"$MODNAME\" "
    modprobe -rs "$MODNAME"
    if [ "$?" != 0 ]
    then
        echo "Unable to unload module \"$MODNAME\"" >&2
        return 1
    fi

    return 0
}


#
# mount_device()
# Mount the /dev/oracleasm filesystem
#
# 0 is success, 1 is error, 2 is already mounted
#
mount_device()
{
    if [ -z "$ORACLE_ASMMANAGER" ]
    then
        echo "mount_device(): No device specified!" >&2
        return 1
    fi
    ORACLE_ASMMANAGERSEARCH="`echo "$ORACLE_ASMMANAGER" | sed -e 's/\//\\\\\//g'`"
    MOUNTOUT="`awk '$2 ~ /^'$ORACLE_ASMMANAGERSEARCH'$/{print $2; exit}' < /proc/mounts 2>/dev/null`"

    if [ -n "$MOUNTOUT" ]
    then
        return 2
    fi

    echo -n "Mounting ASMlib driver filesystem "
    mount $OPTS -t oracleasmfs oracleasmfs $ORACLE_ASMMANAGER
    if [ $? != 0 ]
    then
        echo "Unable to mount ASMlib driver filesystem" >&2
        return 1
    fi

    perm_disk ${ORACLE_ASMMANAGER}/iid
    if [ $? = 1 ]
    then
        echo "Unable to fix ASM driver permissions" >&2
        return 1
    fi

    chmod 0770 ${ORACLE_ASMMANAGER}/iid
    if [ $? = 1 ]
    then
        echo "Unable to fix ASM driver permissions" >&2
        return 1
    fi


    return 0
}


#
# unmount_device()
# Unmount the /dev/oracleasm filesystem
#
# 0 is success, 1 is error, 2 is not mounted
#
unmount_device()
{
    if [ -z "$ORACLE_ASMMANAGER" ]
    then
        echo "mount_device(): No device specified!" >&2
        return 1
    fi
    ORACLE_ASMMANAGERSEARCH="`echo "$ORACLE_ASMMANAGER" | sed -e 's/\//\\\\\//g'`"
    MOUNTOUT="`awk '$2 ~ /^'$ORACLE_ASMMANAGERSEARCH'$/{print $2; exit}' < /proc/mounts 2>/dev/null`"

    if [ -z "$MOUNTOUT" ]
    then
        return 2
    fi

    echo -n "Unmounting ASMlib driver filesystem "
    umount $ORACLE_ASMMANAGER
    if [ $? != 0 ]
    then
        echo "Unable to unmount ASMlib driver filesystem" >&2
        return 1
    fi

    return 0
}


#
# write_sysconfig()
#
# Writes the system configuration out
#
write_sysconfig()
{
    echo -n "Writing Oracle ASM library driver configuration "
    cat >/etc/sysconfig/oracleasm <<EOF
#
# This is a configuration file for automatic loading of the Oracle
# Automatic Storage Management library kernel driver.  It is generated
# By running /etc/init.d/oracleasm configure.  Please use that method
# to modify this file
#

# ORACLEASM_ENABELED: 'true' means to load the driver on boot.
ORACLEASM_ENABLED=${ORACLEASM_ENABLED:-false}

# ORACLEASM_UID: Default user owning the $ORACLE_ASMMANAGER mount point.
ORACLEASM_UID=${ORACLEASM_UID}

# ORACLEASM_GID: Default group owning the $ORACLE_ASMMANAGER mount point.
ORACLEASM_GID=${ORACLEASM_GID}

# ORACLEASM_SCANBOOT: 'true' means fix disk perms on boot
ORACLEASM_SCANBOOT=${ORACLEASM_SCANBOOT}

# ORACLEASM_CLEARBOOT: 'true' means clean old disk perms on boot
ORACLEASM_CLEARBOOT=${ORACLEASM_CLEARBOOT}

# ORACLEASM_SCANORDER: Matching patterns to order disk scanning
ORACLEASM_SCANORDER=${ORACLEASM_SCANORDER}

# ORACLEASM_SCANEXCLUDE: Matching patterns to exclude disks from scan
ORACLEASM_SCANEXCLUDE=${ORACLEASM_SCANEXCLUDE}

EOF

    if [ $? != 0 ]
    then
        return 1
    fi
    return 0
}


#
# configure_ask()
#
# Ask configuration questions, setting the shell vars.
#
configure_ask()
{
    cat <<EOF
Configuring the Oracle ASM library driver.

This will configure the on-boot properties of the Oracle ASM library
driver.  The following questions will determine whether the driver is
loaded on boot and what permissions it will have.  The current values
will be shown in brackets ('[]').  Hitting <ENTER> without typing an
answer will keep that current value.  Ctrl-C will abort.

EOF

    while :
    do
        echo -n "Default user to own the driver interface [$ORACLEASM_UID]: "
        read LINE
        case "$LINE" in
        "")
            break
            ;;
        *[^a-zA-Z0-9]*)
            echo "Invalid user: $LINE" >&2
            ;;
        *)
            ORACLEASM_UID=$LINE
            break
            ;;
        esac
    done

    while :
    do
        echo -n "Default group to own the driver interface [$ORACLEASM_GID]: "
        read LINE
        case "$LINE" in
        "")
            break
            ;;
        *[^a-zA-Z0-9]*)
            echo "Invalid group: $LINE" >&2
            ;;
        *)
            ORACLEASM_GID=$LINE
            break
            ;;
        esac
    done

    while :
    do
        if [ "$ORACLEASM_ENABLED" = "true" ]
        then
            CUR=y
        else
            CUR=n
        fi
        echo -n "Start Oracle ASM library driver on boot (y/n) [$CUR]: "
        read LINE
        case "$LINE" in
        "")
            break
            ;;
        y|Y)
            ORACLEASM_ENABLED=true
            break
            ;;
        n|N)
            ORACLEASM_ENABLED=false
            break
            ;;
        *)
            echo "Invalid GID: $LINE" >&2
            ;;
        esac
    done

    while :
    do
        if [ -z "$ORACLEASM_SCANBOOT" ]
        then
            ORACLEASM_SCANBOOT=true
        fi
        if [ "${ORACLEASM_SCANBOOT}" = "true" ]
        then
            CUR=y
        else
            CUR=n
        fi
        echo -n "Fix permissions of Oracle ASM disks on boot (y/n) [$CUR]: "
        read LINE
        case "$LINE" in
        "")
            break
            ;;
        y|Y)
            ORACLEASM_SCANBOOT=true
            break
            ;;
        n|N)
            ORACLEASM_SCANBOOT=false
            break
            ;;
        *)
            echo "Invalid GID: $LINE" >&2
            ;;
        esac
    done
}


#
# upper_disk()
# Make a disk name uppercase
#
upper_disk()
{
    echo "$1" | tr '[a-z]' '[A-Z]'
}


#
# make_disk()
# Creates an ASM disk.
#
# Returns 0 on success, 1 on error, 2 on already marked.
#
make_disk()
{
    if [ "$#" -lt "2" -o -z "$1" -o -z "$2" ]
    then
        echo "make_disk(): Requires two arguments" >&2
        return 1
    fi
    LABEL="$1"
    DISKNAME="$2"
    if [ ! -z "$3" ]
    then
        MARK="-a mark=$3"
    fi

    OUTPUT="`asmtool -C -l "${ORACLE_ASMMANAGER}" -n "${LABEL}" -s "${DISKNAME}" $MARK 2>&1`"
    if [ $? != 0 ]
    then
        echo -n "Marking disk \"$DISKNAME\" as an ASM disk "
        return 1
    fi
    case "$OUTPUT" in
    *is\ marked*)
        return 2
        ;;
    *)
        ;;
    esac
    echo -n "Marking disk \"$DISKNAME\" as an ASM disk "
    return 0
}


#
# relabel_disk()
# Relabels an ASM disk.
#
# Returns 0 on success, 1 on error.
#
relabel_disk()
{
    if [ "$#" -lt "2" -o -z "$1" -o -z "$2" ]
    then
        echo "relabel_disk(): Requires two arguments" >&2
        return 1
    fi
    OLDDISK="$1"
    NEWLABEL="$2"
    FORCE="$3"

    if [ -z "$FORCE" ]
    then
        REDIR=''
    else
        REDIR='2>&1'
    fi
    OUTPUT="`asmtool -H -l "${ORACLE_ASMMANAGER}" -n "${OLDDISK}" -a "label=${NEWLABEL}" $FORCE $REDIR`"
    if [ $? != 0 ]
    then
        if [ -z "$FORCE" ]
        then
            echo "If you really wish to change the label, rerun with the force-renamedisk command." >&2
        fi
        echo -n "Renaming disk \"$OLDDISK\" to \"$NEWLABEL\" "
        return 1
    fi
    echo -n "Renaming disk \"$OLDDISK\" to \"$NEWLABEL\" "
    return 0
}


#
# remove_disk()
# Removes the  ASM disk.
#
# Returns 0 on success, 1 on error, 2 on not there.
#
remove_disk()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "remove_disk(): Requires an argument" >&2
        return 1
    fi
    DISKNAME="$1"
   
    OUTPUT="`asmtool -D -l "${ORACLE_ASMMANAGER}" -n "${DISKNAME}" 2>&1`"
    if [ $? != 0 ]
    then
        echo -n "Removing ASM disk \"$DISKNAME\" "
        return 1
    fi
    case "$OUTPUT" in
    *not\ marked*)
        return 2
        ;;
    *)
        ;;
    esac
    echo -n "Removing ASM disk \"$DISKNAME\" "
    return 0
}


#
# check_disk()
# Check if the disk is an ASM disk
#
check_disk()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "check_disk(): Requires an argument" >&2
        return 1
    fi
    DISKNAME="$1"

    asmtool -I -l "$ORACLE_ASMMANAGER" -n "$DISKNAME" | sed -e 's/^asmtool: //'
}


#
# perm_disk()
# Set the appropriate permissions on a disk.
#
# Returns 0 on success, 1 on error, 2 on already correct
#
perm_disk()
{
    if [ "$#" -lt "1" -o -z "$1" ]
    then
        echo "perm_disk(): Requires an argument" >&2
        return 1
    fi
    DISKNAME="$1"

    OUTPUT="`ls -ld "${DISKNAME}" 2>/dev/null`"
    if [ $? != 0 ]
    then
        echo -n "Checking ownership of disk \"${DISKNAME}\" "
        return 1
    fi
    OUID="`echo "$OUTPUT" | awk '{print $3}'`"
    OGID="`echo "$OUTPUT" | awk '{print $4}'`"

    if [ "$OUID" = "${ORACLEASM_UID:-root}" -a "$OGID" = "${ORACLEASM_GID:-root}" ]
    then
        return 2
    fi

    chown "${ORACLEASM_UID:-root}:${ORACLEASM_GID:-root}" "$DISKNAME"
    if [ $? != 0 ]
    then
        return 1
    fi

    chmod 0660 "$DISKNAME"
    if [ $? != 0 ]
    then
        return 1
    fi

    return 0
}




#
# scan_disks()
# Scan disks to find any ASM disks and perhaps fix their ownership.
#
# Returns 0 on success, 1 on error, 2 on disabled.
#
scan_disks()
{
    if [ "$ORACLEASM_SCANBOOT" != "true" ]
    then
        return 2
    fi

    echo -n "Scanning system for ASM disks "
    RC=0

    # FIXME Add ordering
    OUTPUT="`asmscan -l "${ORACLE_ASMMANAGER}" 2>/dev/null`"
    if [ $? != 0 ]
    then
        return 1
    fi

    ls -1 "${ORACLE_ASMMANAGER}/disks" | while read LINE
        do
            perm_disk "${ORACLE_ASMMANAGER}/disks/${LINE}"
            if [ $? = 1 ]
            then
                echo "Unable to fix permissions on ASM disk \"$LINE\"" >&2
                return 1
            fi
        done

    return 0
}

